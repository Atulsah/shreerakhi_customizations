[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer Visit",
  "enabled": 1,
  "modified": "2025-10-18 13:50:57.178937",
  "module": "Shree",
  "name": "Custom Customer Visit",
  "script": "frappe.ui.form.on('Customer Visit', {\r\n\r\n    // ----------------------\r\n    // Form Load\r\n    // ----------------------\r\n    onload: function(frm) {\r\n        // Fetch states from Address DocType (client-side)\r\n        frappe.db.get_doc('DocType', 'Address').then(address_doctype => {\r\n            let state_field = address_doctype.fields.find(f => f.fieldname === 'state');\r\n            if (state_field && state_field.options) {\r\n                let states = state_field.options.split('\\n');\r\n                frm.set_df_property('state', 'options', states.join('\\n'));\r\n            }\r\n        });\r\n    },\r\n\r\n    // ----------------------\r\n    // Form Refresh\r\n    // ----------------------\r\n    refresh: function(frm) {\r\n        toggle_buttons(frm);\r\n        calculate_days_before(frm);\r\n    },\r\n\r\n    // ----------------------\r\n    // Field Change Events\r\n    // ----------------------\r\n    visit_date: function(frm) {\r\n        calculate_days_before(frm);\r\n    },\r\n\r\n    d_day: function(frm) {\r\n        calculate_days_before(frm);\r\n    },\r\n\r\n    customer_type: function(frm) {\r\n        toggle_buttons(frm);\r\n    },\r\n\r\n    customer: async function(frm) {\r\n        if (!frm.doc.customer) {\r\n            frm.set_value('customer_details', '');\r\n            frm.fields_dict.address_html.$wrapper.html('');\r\n            return;\r\n        }\r\n\r\n        // Fetch customer doc including primary address\r\n        let customer_doc = await frappe.db.get_doc('Customer', frm.doc.customer);\r\n\r\n        let address_html = '';\r\n        let details_html = '';\r\n\r\n        if (customer_doc.customer_primary_address) {\r\n            // Fetch the primary address doc\r\n            let addr = await frappe.db.get_doc('Address', customer_doc.customer_primary_address);\r\n\r\n            let full_address = `\r\n                ${addr.address_line1 || ''}<br>\r\n                ${addr.address_line2 || ''}<br>\r\n                ${addr.city || ''}, ${addr.state || ''} - ${addr.pincode || ''}<br>\r\n            `;\r\n\r\n            address_html = `\r\n                <div style=\"line-height:1.5; font-size:13px;\">\r\n                    <b>Address:</b><br>${full_address}\r\n                    <b>Contact:</b> ${addr.phone || ''}<br>\r\n                    <b>GSTIN:</b> ${addr.gstin || ''}<br>\r\n                </div>\r\n            `;\r\n\r\n            details_html = `\r\n                <b>Name:</b> ${customer_doc.customer_name}<br>\r\n                <b>Address:</b> ${addr.address_line1 || ''}, ${addr.city || ''}<br>\r\n                <b>Contact:</b> ${addr.phone || ''}<br>\r\n                <b>GSTIN:</b> ${addr.gstin || ''}<br>\r\n            `;\r\n        } else {\r\n            details_html = `<b>Name:</b> ${customer_doc.customer_name}<br><span style=\"color:gray;\">No primary address found</span>`;\r\n            address_html = `<span style=\"color:gray;\">No primary address linked</span>`;\r\n        }\r\n\r\n        frm.set_value('customer_details', details_html);\r\n        frm.refresh_field('customer_details');\r\n        frm.fields_dict.address_html.$wrapper.html(address_html);\r\n    },\r\n\r\n    edit_customer_button: function(frm) {\r\n        if (frm.doc.customer) {\r\n            frappe.set_route('Form', 'Customer', frm.doc.customer);\r\n        } else {\r\n            frappe.msgprint('Please select a customer first');\r\n        }\r\n    },\r\n\r\n    create_new_customer_button: function(frm) {\r\n        frappe.new_doc('Customer');\r\n    }\r\n\r\n});\r\n\r\n// ----------------------\r\n// Helper Functions\r\n// ----------------------\r\nfunction calculate_days_before(frm) {\r\n    if(frm.doc.visit_date && frm.doc.d_day) {\r\n        frm.set_value('days_before_d_day', frappe.datetime.get_diff(frm.doc.d_day, frm.doc.visit_date));\r\n    } else {\r\n        frm.set_value('days_before_d_day', null);\r\n    }\r\n}\r\n\r\nfunction toggle_buttons(frm) {\r\n    if (frm.doc.customer_type === 'Old Customer') {\r\n        frm.set_df_property('customer', 'reqd', 1);\r\n        frm.set_df_property('edit_customer_button', 'hidden', 0);\r\n        frm.set_df_property('create_new_customer_button', 'hidden', 1);\r\n    } else if (frm.doc.customer_type === 'New Customer') {\r\n        frm.set_df_property('customer', 'reqd', 0);\r\n        frm.set_df_property('edit_customer_button', 'hidden', 1);\r\n        frm.set_df_property('create_new_customer_button', 'hidden', 0);\r\n        frm.set_value('customer', '');\r\n        frm.set_value('customer_details', '');\r\n        frm.fields_dict.address_html.$wrapper.html('');\r\n    }\r\n}\r\n\r\n\r\n// ----------------------\r\n// Filter Customer by State/City (Working Version)\r\n// ----------------------\r\nfunction set_customer_query(frm) {\r\n    frm.set_query('customer', async function() {\r\n        let filters = [];\r\n        if (frm.doc.state) filters.push(['state', '=', frm.doc.state]);\r\n        if (frm.doc.city) filters.push(['city', '=', frm.doc.city]);\r\n\r\n        if (filters.length === 0) return {}; // no filter if both empty\r\n\r\n        // Fetch addresses first\r\n        let addresses = await frappe.db.get_list('Address', {\r\n            fields: ['name'],\r\n            filters: filters\r\n        });\r\n\r\n        let address_names = addresses.map(a => a.name);\r\n\r\n        return {\r\n            filters: {\r\n                customer_primary_address: ['in', address_names]\r\n            }\r\n        };\r\n    });\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-09-02 18:33:02.787957",
  "module": "Shree",
  "name": "Custom Stock Entry",
  "script": "frappe.ui.form.on('Stock Entry', {\r\n    refresh: function(frm) {\r\n        frm.doc.items.forEach(row => {\r\n            let workstation = frm.doc.custom_factory__location || \"\";\r\n            let bill_no = frm.doc.custom_bill_no || \"\";\r\n            let combined_value = workstation && bill_no\r\n                ? (workstation + \"-\" + bill_no)\r\n                : (workstation || bill_no);\r\n\r\n            frappe.model.set_value(row.doctype, row.name, 'custom_factory_bill_no', combined_value);\r\n        });\r\n    }\r\n});\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2025-10-14 16:54:42.784569",
  "module": "Shree",
  "name": "Custom Sales Invoice",
  "script": "frappe.ui.form.on(\"Sales Invoice\", {\r\n    refresh: function(frm) {\r\n        frm.fields_dict['custom_bos_transporter'].get_query = function(doc) {\r\n            return {\r\n                filters: {\r\n                    is_transporter: 1\r\n                }\r\n            };\r\n        };\r\n    }\r\n});\r\n\r\nfrappe.ui.form.on('Sales Invoice Item', {\r\n    item_code: function(frm, cdt, cdn) {\r\n        check_duplicate_item(frm, cdt, cdn);\r\n    },\r\n\r\n    items_add: function(frm, cdt, cdn) {\r\n        check_duplicate_item(frm, cdt, cdn);\r\n    }\r\n});\r\n\r\n// ---------- Helper Function ----------\r\nfunction check_duplicate_item(frm, cdt, cdn) {\r\n    let row = locals[cdt][cdn];\r\n    if (!row.item_code) return;\r\n\r\n    let duplicates = frm.doc.items\r\n        .map((item, index) => ({ item_code: item.item_code, row: index + 1 }))\r\n        .filter(item => item.item_code === row.item_code);\r\n\r\n    if (duplicates.length > 1) {\r\n        // Find the first occurrence row number\r\n        let first_row = duplicates[0].row;\r\n        frappe.msgprint({\r\n            title: __(\"Duplicate Item Found\"),\r\n            message: __(\"Item <b>{0}</b> has already been added earlier (Row {1}).\", [row.item_code, first_row]),\r\n            indicator: \"red\"\r\n        });\r\n\r\n        frappe.model.clear_doc(cdt, cdn);\r\n        frm.refresh_field('items');\r\n    }\r\n}\r\n",
  "view": "Form"
 }
]